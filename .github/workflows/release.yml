name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Build Executable
    runs-on: macos-15

    outputs:
      version: ${{ steps.version-info.outputs.version }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Compute Version
        id: version-info
        run: |
          TAG_NAME="${{ github.ref_name }}"
          echo "version=${TAG_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Setup Swift
        uses: ./.github/actions/setup-swift

      - name: Run Tests
        run: make test

      - name: Generate Version File
        run: |
          make generate-version VERSION="${{ steps.version-info.outputs.version }}"

      - name: Build Release Binary
        run: make build

      - name: Verify Binary
        run: |
          echo "ðŸ” Verifying binary works..."
          ./bin/arrow --version

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: bin/arrow
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  homebrew:
    name: Update Homebrew Formula
    runs-on: macos-15
    needs: [release]

    steps:
      - name: Get Latest Release Info
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          TAG_NAME="v$VERSION"
          BINARY_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/arrow"

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BINARY_URL=$BINARY_URL" >> $GITHUB_ENV

      - name: Download Binary and Calculate SHA-256
        run: |
          wget -O arrow "$BINARY_URL"
          chmod +x arrow
          SHA256=$(shasum -a 256 arrow | awk '{print $1}')
          echo "SHA256=$SHA256" >> $GITHUB_ENV

      - name: Update Homebrew Formula
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          brew tap ${{ github.repository_owner }}/homebrew-tap
          brew bump-formula-pr -f --version=$VERSION --no-browse --no-audit \
            --sha256=$SHA256 \
            --url="$BINARY_URL" \
            ${{ github.repository_owner }}/homebrew-tap/arrow
