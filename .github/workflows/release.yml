name: Release

on:
  push:
    tags:
      - '*.*.*'

jobs:
  release:
    name: Build Executable
    runs-on: macos-14

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Read Swift Version
        id: swift-version
        run: echo "version=$(cat .swift-version)" >> $GITHUB_OUTPUT

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ steps.swift-version.outputs.version }}

      - name: Cache Swift Packages
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Run Tests
        run: make test

      - name: Build Release Binary
        run: make build

      - name: Verify Binary
        run: |
          echo "ðŸ” Verifying binary works..."
          ./bin/arrow --version

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: bin/arrow
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: [release]

    steps:
      - name: Get Latest Release Info
        run: |
          TAG_NAME=${{ github.ref_name }}
          BINARY_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/arrow"

          echo "VERSION=$TAG_NAME" >> $GITHUB_ENV
          echo "BINARY_URL=$BINARY_URL" >> $GITHUB_ENV

      - name: Download Binary and Calculate SHA-256
        run: |
          wget -O arrow "$BINARY_URL"
          SHA256=$(shasum -a 256 arrow | awk '{print $1}')
          echo "SHA256=$SHA256" >> $GITHUB_ENV

      - name: Update Homebrew Formula
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          brew tap ${{ github.repository_owner }}/homebrew-tap
          brew bump-formula-pr -f --version=$VERSION --no-browse --no-audit \
            --sha256=$SHA256 \
            --url="$BINARY_URL" \
            ${{ github.repository_owner }}/homebrew-tap/arrow
